// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model JobListing {
  id                   String    @id @default(uuid()) @map("job_id")
  buyerId              String    @map("buyer_id")
  firstName            String?   @map("first_name")
  lastName             String?   @map("last_name")
  email                String?   @map("email")
  contactNumber        String?   @map("contact_number")
  serviceCategoryId    Int?      @map("service_category_id")
  serviceCategoryName  String?   @map("service_category_name")
  title                String
  description          String?
  budget               Json      // { min: 100, max: 200 }
  startDate            String?   @map("start_date")
  endDate              String?   @map("end_date")
  location             Json?     // { address: "...", lat: ..., lng: ... }
  priorities           Json?
  specificRequirements Json?     @map("specific_requirements")
  status               String    @default("open")
  numBidsReceived      Int       @default(0) @map("num_bids_received")
  selectedSellerId     String?   @map("selected_seller_id")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  bids                 SellerBid[]
  embeddings           JobsEmbedding[]

  @@map("job_listings")
}

model SellerProfile {
  id                       String   @id @default(uuid()) @map("seller_id")  // Profile UUID - SellerBid references this
  providerId               Int      @map("provider_id")  // External provider ID - one provider can have multiple profiles
  firstName                String?  @map("first_name")   // From provider-basic-details API
  lastName                 String?  @map("last_name")
  email                    String?  @map("email")
  gender                   Int?     @map("gender")       // 1=male, 2=female, etc from API
  contactNumber            String?  @map("contact_number")
  serviceCategoryNames     String[] @default([]) @map("service_category_names")
  serviceArea              Json?    @map("service_area")
  availability             Json?
  credentials              Json?
  pricing                  Json?
  preferences              Json?
  bio                      String?
  profileCompletenessScore Int      @default(0) @map("profile_completeness_score")
  active                   Boolean  @default(true)
  totalBidsSubmitted       Int      @default(0) @map("total_bids_submitted")
  totalBidsAccepted        Int      @default(0) @map("total_bids_accepted")
  embeddingDone            Boolean  @default(false) @map("embedding_done")
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  bids                     SellerBid[]
  embeddings               SellerEmbedding[]

  @@index([providerId])
  @@map("seller_profiles")
}

model SellerBid {
  id                     String    @id @default(uuid()) @map("bid_id")
  jobId                  String    @map("job_id")
  sellerId               String    @map("seller_id")
  quotedPrice            Decimal   @map("quoted_price")
  quotedTimeline         String?   @map("quoted_timeline")
  quotedCompletionDays   Int?      @map("quoted_completion_days")
  paymentTerms           String?   @map("payment_terms")
  canMeetDates           Boolean?  @map("can_meet_dates")
  message                String?
  sellerCredentials      Json?     @map("seller_credentials")
  status                 String    @default("pending")
  buyerResponse          String?   @map("buyer_response")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  job                    JobListing   @relation(fields: [jobId], references: [id])
  seller                 SellerProfile @relation(fields: [sellerId], references: [id])

  @@map("seller_bids")
}

// ============================================================
// NEW MODELS (Sessions - No Expiry)
// ============================================================

// Conversation Sessions (permanent - no expiry)
model ConversationSession {
  id              String    @id @default(uuid()) @map("session_id")
  userId          String    @map("user_id")
  userType        String    @map("user_type") // 'buyer' or 'seller'
  accessToken     String    @map("access_token")
  phase           String    @default("conversation") // conversation, confirmation, negotiation, etc.
  state           Json      // All collected data (budget, service, etc.)
  jobId           String?   @map("job_id") // Reference to created job
  profileId       String?   @map("profile_id") // Reference to created seller profile (for sellers)
  isActive        Boolean   @default(true) @map("is_active") // Mark inactive when user explicitly ends
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  messages        ConversationMessage[]

  @@index([userId, userType])
  @@index([userId, isActive])
  @@index([profileId])
  @@map("conversation_sessions")
}

// Conversation Messages (permanent history)
model ConversationMessage {
  id              Int       @id @default(autoincrement())
  sessionId       String    @map("session_id")
  role            String    // 'user', 'assistant', 'system'
  content         String    @db.Text
  metadata        Json?     // Additional data (intent, extraction, etc.)
  createdAt       DateTime  @default(now()) @map("created_at")

  session         ConversationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("conversation_messages")
}

// Negotiation Sessions (permanent)
model NegotiationSession {
  id                  String    @id @default(uuid())
  jobId               String    @map("job_id")
  providerId          String    @map("provider_id")
  buyerId             String    @map("buyer_id")
  state               Json      // Full negotiation state
  status              String    @default("collecting") // collecting, done, timeout
  quote               Json?     // Final quote
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  messages            NegotiationMessage[]

  @@unique([jobId, providerId])
  @@index([jobId])
  @@index([providerId])
  @@map("negotiation_sessions")
}

model NegotiationMessage {
  id                  Int       @id @default(autoincrement())
  negotiationId       String    @map("negotiation_id")
  role                String    // 'buyer' or 'seller'
  message             String    @db.Text
  createdAt           DateTime  @default(now()) @map("created_at")

  negotiation         NegotiationSession @relation(fields: [negotiationId], references: [id], onDelete: Cascade)

  @@index([negotiationId, createdAt])
  @@map("negotiation_messages")
}

// Memory/Patterns (permanent learning)
model UserMemory {
  id                  String    @id @default(uuid())
  userId              String    @map("user_id")
  userType            String    @map("user_type") // 'buyer' or 'seller'
  memoryType          String    @map("memory_type") // 'negotiation', 'preference', 'pattern'
  category            String?   // Service category or job type
  content             String    @db.Text // Natural language summary
  metadata            Json      // Structured data (prices, ratings, etc.)
  relevanceScore      Float     @default(1.0) @map("relevance_score")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([userId, userType])
  @@index([userId, category])
  @@index([memoryType])
  @@map("user_memories")
}

// Cache (with expiry for performance optimization only)
model CacheEntry {
  id                  String    @id @default(uuid())
  key                 String    @unique // 'service_categories:all', 'provider:123:details'
  value               Json      // Cached data
  expiresAt           DateTime  @map("expires_at") // Keep expiry ONLY for cache
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([key])
  @@index([expiresAt])
  @@map("cache_entries")
}


model SellerEmbedding {
  id          String   @id @default(uuid())
  sellerId    String   @map("seller_id")
  embedding   Unsupported("vector(1536)") 
  searchableText String @map("searchable_text")
  updatedAt   DateTime @updatedAt @map("updated_at")

  seller      SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@map("seller_embeddings")
}

model JobsEmbedding {
  id             String   @id @default(uuid()) @map("embedding_id")
  jobId          String   @map("job_id")
  embedding      Unsupported("vector(1536)")
  searchableText String   @map("searchable_text")
  updatedAt      DateTime @updatedAt @map("updated_at")

  job            JobListing @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@map("job_embeddings")
}
